<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The London Free Press - Home</title>

    <meta name="chat-context-publication" content="London Free Press">
    <meta name="chat-context-page" content="Home"> 

    <style>
        /* --- GLOBAL STYLES (Newspaper Look) --- */
        body { margin: 0; font-family: 'Georgia', serif; background-color: #f4f4f4; color: #333; }
        
        /* HEADER */
        header { background-color: #000; color: #fff; padding: 15px 0; border-bottom: 4px solid #cc0000; }
        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; }
        .logo { font-size: 28px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        
        /* NAVIGATION */
        nav { border-top: 1px solid #333; padding-top: 10px; }
        nav a { color: #fff; text-decoration: none; margin-right: 25px; font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; text-transform: uppercase; }
        nav a:hover { color: #cc0000; }

        /* CONTENT LAYOUT */
        .main-content { background: #fff; margin-top: 20px; padding: 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); min-height: 500px; }
        h1 { font-size: 32px; margin-bottom: 10px; color: #111; }
        .article-meta { color: #888; font-size: 12px; font-family: Arial, sans-serif; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        p { line-height: 1.6; font-size: 18px; margin-bottom: 20px; }

        /* FOOTER */
        footer { background: #111; color: #777; padding: 40px 0; margin-top: 40px; text-align: center; font-family: Arial, sans-serif; font-size: 12px; }

        /* --- CHAT BUTTON STYLES --- */
        #endChatButton {
            display: none; /* Hidden by default, shown via JS */
            position: fixed; bottom: 35px; right: 30px; z-index: 999999;
            padding: 8px 16px; background-color: #d9534f; color: white;
            border: none; border-radius: 4px; cursor: pointer; font-family: Arial, sans-serif; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #endChatButton:hover { background-color: #c9302c; }
        #endChatButton:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>

    <script>
        !function (o, i, s, c) { var a, p, h, u = [], l = []; function e() { var t = "You must provide a supported major version."; try { if (!c) throw new Error(t); var e, n = "https://sdk.cxengage.net/webchat/2.2.3/", r = "serenovawebchat"; if ((e = "string" == typeof this.response ? JSON.parse(this.response) : this.response).url) { var o = i.getElementsByTagName("script")[0], s = i.createElement("script"); s.async = !0; var a = c.match(/([0-9]+)\.?([0-9]+)?\.?([0-9]+)?/), p = a && a[1]; if (a && a[3]) s.src = n + r + "." + c + ".min.js"; else { if (!(1 <= p && e["v" + p])) throw new Error(t); s.src = e["v" + p] } o.parentNode.insertBefore(s, o) } } catch (e) { e.message === t && console.error(e) } } o[s] = { init: function () { a = arguments; var t = { then: function (e) { return l.push({ type: "t", next: e }), t }, catch: function (e) { return l.push({ type: "c", next: e }), t } }; return t }, on: function () { u.push(arguments) }, render: function () { p = arguments }, destroy: function () { h = arguments } }, o.__onWebMessengerHostReady__ = function (e) { if (delete o.__onWebMessengerHostReady__, o[s] = e, a) for (var t = e.init.apply(e, a), n = 0; n < l.length; n++) { var r = l[n]; t = "t" === r.type ? t.then(r.next) : t.catch(r.next) } p && e.render.apply(e, p), h && e.destroy.apply(e, h); for (n = 0; n < u.length; n++)e.on.apply(e, u[n]) }; var t = new XMLHttpRequest; t.addEventListener("load", e), t.open("GET", "https://sdk.cxengage.net/webchat/2.2.3/loader.json", !0), t.responseType = "json", t.send() }(window, document, "SerenovaWebChat", "2");
    </script>
</head>
<body>

    <header>
        <div class="container">
            <div class="header-top">
                <div class="logo">The London Free Press</div>
            </div>
            <nav>
                <a href="index.html">Home</a>
                <a href="faqs.html">FAQs</a>
                <a href="subscription.html">Subscription</a>
            </nav>
        </div>
    </header>

    <div class="container main-content">
        <h1>Local Council Approves New Downtown Park</h1>
        <div class="article-meta">By <strong>John Doe</strong> | Published Jan 07, 2026 | Local News</div>
        
        <p>LONDON, ON â€” City council voted unanimously last night to approve the development of a new green space in the downtown core. The project, slated to begin next summer, will transform the old parking lot into a vibrant community hub.</p>
        <p>"This is a huge win for the city," said Mayor Smith. "It brings nature back to our urban center."</p>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 30px 0;">
        <h3>More Top Stories</h3>
        <ul>
            <li>Winter storm expected to hit region on Friday.</li>
            <li>Local hockey team secures playoff spot.</li>
            <li>Tech startup announces 50 new jobs.</li>
        </ul>
    </div>

    <footer>
        <div class="container">
            &copy; 2026 Postmedia Network Inc. All rights reserved.<br>
            Unauthorized distribution, transmission or republication strictly prohibited.
        </div>
    </footer>

    <button id="endChatButton">End Chat</button>

    <script>
        // Global Configuration
        const CHAT_CONFIG = {
            integrationId: '695ebfa206a2d040ec8f035a',
            storageType: 'sessionStorage'
        };

        let activeConversationId = null;
        const endChatBtn = document.getElementById('endChatButton');

        /**
         * 1. GET CONTEXT
         * Reads the <meta> tags from the <head> of the current HTML file.
         */
        function getPageContext() {
            const pubMeta = document.querySelector('meta[name="chat-context-publication"]');
            const pageMeta = document.querySelector('meta[name="chat-context-page"]');

            return {
                publication: pubMeta ? pubMeta.content : 'Unknown Publication',
                pageSource: pageMeta ? pageMeta.content : 'Unknown Page',
                url: window.location.href
            };
        }

        /**
         * 2. INIT CHAT
         * Initializes the SDK and sends the specific page data.
         */
        function initChatWidget() {
            if (typeof SerenovaWebChat === 'undefined') {
                setTimeout(initChatWidget, 100);
                return;
            }

            const options = {
                integrationId: CHAT_CONFIG.integrationId,
                canUserSeeConversationList: false, // Hide conversation history
                browserStorage: CHAT_CONFIG.storageType,
                customText: {
                    headerText: "Contact Us",  // Custom header text
                    prechatCaptureGreetingText: `Thank you for contacting London Free Press. If this is an emergency, please call immediately.`,
                    inputPlaceholderBlocked: 'Please complete the form above to start chatting.'
                },

                prechatCapture: {
                    
                    fields: [
                        {
                            type: 'text',
                            name: 'name',
                            label: 'To get started, please enter your name below.',
                            placeholder: 'your name',
                        },
                        
                    ],
                },
                delegate: {
                    beforeDisplay: (message) => {
                        // Capture Conversation ID
                        if (message?.metadata?.conversationId) {
                            activeConversationId = message.metadata.conversationId;
                        }
                        return message;
                    }
                }
            };

            SerenovaWebChat.init(options).then(() => {
                console.log("SDK Initialized successfully.");

                // A. READ CONTEXT FROM META TAGS
                const context = getPageContext();
                console.log(`[Chat Context] Sending: ${context.pageSource} (${context.publication})`);

                // B. SEND CONTEXT TO AGENT
                SerenovaWebChat.updateUser({
                    properties: {
                        publication: context.publication,
                        pageSource: context.pageSource,
                        sourceUrl: context.url
                    }
                }).catch(err => console.error("Failed to update user properties:", err));

                // C. UI LISTENERS (Show/Hide Button)
                SerenovaWebChat.on('widget:opened', () => endChatBtn.style.display = 'block');
                SerenovaWebChat.on('widget:closed', () => endChatBtn.style.display = 'none');
            });
        }

        /**
         * 3. END CHAT FUNCTIONALITY
         * Gracefully disconnects and resets the session.
         */
        function handleEndChat() {
            endChatBtn.innerText = "Ending...";
            endChatBtn.disabled = true;

            const performReset = () => {
                SerenovaWebChat.destroy();
                sessionStorage.clear();
                activeConversationId = null;
                endChatBtn.style.display = 'none';
                endChatBtn.innerText = "End Chat";
                endChatBtn.disabled = false;
                
                // Re-initialize for the next potential session
                setTimeout(initChatWidget, 1000);
            };

            if (activeConversationId) {
                // Send disconnect signal to backend
                SerenovaWebChat.sendMessage({
                    type: 'text',
                    text: 'disconnect-conversation',
                    metadata: { type: 'disconnect-conversation' }
                }, activeConversationId)
                .then(() => setTimeout(performReset, 500))
                .catch(() => performReset());
            } else {
                performReset();
            }
        }

        // Start execution when DOM is ready
        document.addEventListener('DOMContentLoaded', initChatWidget);
        endChatBtn.addEventListener('click', handleEndChat);

    </script>
</body>
</html>